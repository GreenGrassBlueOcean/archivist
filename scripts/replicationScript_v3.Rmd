---
title: "archivist: An R Package for Managing, Recording and Restoring Data Analysis Results"
author: "Replication script"
output: html_document
---

# Intro

This is the replication script for 'archivist: An R Package for Managing, Recording and Restoring Data Analysis Results' (Przemyslaw Biecek, Marcin Kosinski) submitted to JSS. 

First, make sure that `archivist` is installed.

```{r, warning=FALSE, message=FALSE}
if (!require(archivist)) {
  install.packages("archivist")
  library(archivist)
}
```

# Section 2. Motivation

Reading artifacts from GitHub

```{r}
archivist::aread('pbiecek/Eseje/arepo/e10f9d223df408fca73ea548456493f4')
```

Reading artifacts from package

```{r}
library("archivist")
models <- asearch("pbiecek/graphGallery", patterns = "class:lm")
modelsBIC <- sapply(models, BIC)
sort(modelsBIC)
```

Reading artifacts from Shiny

```{r}
archivist::aread('http://mi2.mini.pw.edu.pl:8080/archivist/arepo/feb011baa9f607e8b4d941d517374eaf')
```

# Section 3. Functionality

## Section 3.1

### Repository management

Creation of a new empty repository

```{r}
repo <- "arepo"
createLocalRepo(repoDir = repo, default = TRUE)
```

Deletion of an existing repository

```{r}
repo <- "arepo"
deleteLocalRepo(repoDir = repo)
```

Copying artifacts from other repositories

```{r}
repo <- "arepo"
createLocalRepo(repoDir = repo, default = TRUE)
copyRemoteRepo(repoTo = repo, md5hashes= "f05f0ed0662fe01850ec1b928830ef32", 
         user = "pbiecek", repo = "graphGallery", repoType = "github")
```

Showing repository statistics

```{r}
showLocalRepo(repoDir = repo, method = "tags")
```

```{r}
summaryLocalRepo(repoDir = 
    system.file("graphGallery", package = "archivist")) 
```

Setting a default repository

```{r}
setRemoteRepo(user = "pbiecek", repo = "graphGallery", repoType = "github")
setLocalRepo(repoDir = system.file("graphGallery", package = "archivist"))
```

Saving to the default local repository

```{r}
setLocalRepo(repoDir = repo)
data(iris)
saveToLocalRepo(iris)
```


```{r}
aoptions("repoType", "github")
```

## Section 3.2

Artifact management

### Saving an R object into a repository

```{r}
library("ggplot2")
repo <- "arepo"
pl <- qplot(Sepal.Length, Petal.Length, data = iris)
saveToRepo(pl, repoDir = repo)

showLocalRepo(repoDir = repo, "tags")
```

Session info for this object

```{r}
asession("11127cc6ce69a89d11d0e30865a33c13")
```

### Serialization of an object creation event into repository

```{r, message=FALSE, warning=FALSE}
library("archivist")
createLocalRepo("arepo", default = TRUE)
library("dplyr")
iris %a%
   filter(Sepal.Length < 6) %a%
   lm(Petal.Length~Species, data=.) %a%
   summary() -> tmp

ahistory(tmp)
ahistory(md5hash = "050e41ec3bc40b3004bc6bdd356acae7")
```

## Loading an object from a repository

Femote, local or in a package

```{r}
loadFromRemoteRepo("f05f0ed0662fe01850ec1b928830ef32", repo="graphGallery", user="pbiecek", 
                             value=TRUE)
loadFromLocalRepo("f05f0ed", system.file("graphGallery", package = "archivist"), value=TRUE)

archivist::aread("pbiecek/graphGallery/f05f0ed0662fe01850ec1b928830ef32")

library("archivist")
setLocalRepo(system.file("graphGallery", package = "archivist"))
# loadFromLocalRepo("f05f0ed", value=TRUE)
archivist::aread("f05f0ed")
```

```{r}
setLocalRepo(system.file("graphGallery", package = "archivist"))
model <- aread("2a6e492cb6982f230e48cf46023e2e4f")
summary(model)
digest::digest(model)
```

### Removal of an object from repository

```{r}
rmFromLocalRepo("f05f0ed0662fe01850ec1b928830ef32", repoDir = repo)
```

Remove all older than 30 days

```{r}
(obj2rm <- searchInLocalRepo(list(dateFrom = "2010-01-01", dateTo = Sys.Date() - 30), repoDir = repo))

rmFromLocalRepo(obj2rm, repoDir = repo, many = TRUE)
```

## 3.3 Search for an artifact

### Search in a local/GitHub repository

```{r}
searchInLocalRepo(pattern = "class:gg", 
    repoDir = system.file("graphGallery", package = "archivist"))

searchInLocalRepo(pattern = list(dateFrom = "2016-01-01",
    dateTo = "2016-02-07" ), 
    repoDir = system.file("graphGallery", package = "archivist"))


searchInLocalRepo(pattern=c("class:gg", "labelx:Sepal.Length"),
         repoDir = system.file("graphGallery", package = "archivist"))	
```


```{r}
setLocalRepo(system.file("graphGallery", package = "archivist"))
models <- asearch(patterns = c("class:lm", "coefname:Sepal.Length"))
models <- asearch("pbiecek/graphGallery",  
    patterns = c("class:lm", "coefname:Sepal.Length"))
lapply(models, coef)

plots <- asearch(patterns = c("class:gg", "labelx:Sepal.Length"))
length(plots)

library("gridExtra")
do.call(grid.arrange, plots)

```

Interactive search

```{r, eval=FALSE}
arepo <- system.file("graphGallery", package = "archivist")
#shinySearchInLocalRepo(arepo)
```

Delete

```{r}
deleteLocalRepo("arepo")
```

# Section 3.5

```{r}
library("archivist")
createLocalRepo("allModels", default = TRUE)
atrace("lm", "z")
lm(Sepal.Length~Sepal.Width, data=iris)
lm(Sepal.Length~Petal.Length, data=iris)
lm(Sepal.Length~Petal.Length, data=iris)
sapply(asearch("class:lm"), BIC)
deleteLocalRepo("allModels")
```

```{r}
asession("pbiecek/graphGallery/arepo/600bda83cb840947976bd1ce3a11879d")
```

# R Session

```{r}
sessionInfo()
```


